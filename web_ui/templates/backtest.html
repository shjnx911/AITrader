{% extends "layout.html" %}

{% block title %}Backtest Data & AI Training{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Alerts container -->
    <div id="alertsContainer"></div>
    
    <h1 class="mb-4">Backtest Data & AI Training</h1>
    
    <div class="row">
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Import Backtest Data</h5>
                    <span class="badge bg-primary">Step 1</span>
                </div>
                <div class="card-body">
                    <form id="importForm">
                        <div class="mb-3">
                            <label for="backtestFile" class="form-label">Backtest JSON File</label>
                            <input class="form-control" type="file" id="backtestFile" accept=".json" multiple>
                            <div class="form-text">Upload one or more Freqtrade backtest result files (JSON format)</div>
                        </div>
                        <div class="mb-3">
                            <label for="strategySelect" class="form-label">Strategy</label>
                            <select class="form-select" id="strategySelect" multiple>
                                <option value="" disabled>Select one or more strategies</option>
                            </select>
                            <div class="form-text">Hold Ctrl/Cmd to select multiple strategies for comparison</div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-file-import me-2"></i>Import Data
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">AI Training Configuration</h5>
                    <span class="badge bg-success">Step 2</span>
                </div>
                <div class="card-body">
                    <form id="trainForm">
                        <div class="mb-3">
                            <label for="pairSelect" class="form-label">Trading Pair</label>
                            <select class="form-select" id="pairSelect">
                                <option value="" selected disabled>Select a pair</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="timeframeSelect" class="form-label">Timeframe</label>
                            <select class="form-select" id="timeframeSelect">
                                <option value="" selected disabled>Select a timeframe</option>
                                <option value="1m">1 minute</option>
                                <option value="5m">5 minutes</option>
                                <option value="15m">15 minutes</option>
                                <option value="1h">1 hour</option>
                                <option value="4h">4 hours</option>
                                <option value="1d">1 day</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="modelType" class="form-label">Model Type</label>
                            <select class="form-select" id="modelType">
                                <option value="lightgbm" selected>LightGBM (Default)</option>
                                <option value="xgboost">XGBoost</option>
                                <option value="catboost">CatBoost</option>
                                <option value="randomforest">Random Forest</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="modelName" class="form-label">Model Name</label>
                            <input type="text" class="form-control" id="modelName" placeholder="MyModel_v1">
                        </div>
                        
                        <div class="accordion mb-3" id="accordionAdvanced">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdvanced">
                                        Advanced Parameters
                                    </button>
                                </h2>
                                <div id="collapseAdvanced" class="accordion-collapse collapse" data-bs-parent="#accordionAdvanced">
                                    <div class="accordion-body">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="autoOptimize" checked>
                                            <label class="form-check-label" for="autoOptimize">
                                                <strong>Auto-optimize hyperparameters</strong>
                                            </label>
                                            <div class="form-text">Automatically find the best parameters using Bayesian optimization</div>
                                        </div>
                                        
                                        <div id="manualParamsContainer">
                                            <div class="mb-2">
                                                <label for="numLeaves" class="form-label">num_leaves</label>
                                                <input type="number" class="form-control form-control-sm" id="numLeaves" value="31">
                                            </div>
                                            <div class="mb-2">
                                                <label for="maxDepth" class="form-label">max_depth</label>
                                                <input type="number" class="form-control form-control-sm" id="maxDepth" value="-1">
                                            </div>
                                            <div class="mb-2">
                                                <label for="learningRate" class="form-label">learning_rate</label>
                                                <input type="number" class="form-control form-control-sm" id="learningRate" value="0.1" step="0.01">
                                            </div>
                                            <div class="mb-2">
                                                <label for="nEstimators" class="form-label">n_estimators</label>
                                                <input type="number" class="form-control form-control-sm" id="nEstimators" value="100">
                                            </div>
                                        </div>
                                        
                                        <hr>
                                        
                                        <div class="mb-3">
                                            <label for="featureSelection" class="form-label">Feature Selection Method</label>
                                            <select class="form-select form-select-sm" id="featureSelection">
                                                <option value="none">None</option>
                                                <option value="recursive" selected>Recursive Feature Elimination</option>
                                                <option value="importance">Feature Importance</option>
                                                <option value="pca">PCA</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="validationMethod" class="form-label">Validation Method</label>
                                            <select class="form-select form-select-sm" id="validationMethod">
                                                <option value="train_test" selected>Train/Test Split</option>
                                                <option value="cross_validation">Cross-Validation</option>
                                                <option value="time_series">Time Series CV</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="enableDML" checked>
                                            <label class="form-check-label" for="enableDML">
                                                Enable DirectML (AMD GPU)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-brain me-2"></i>Train AI Model
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- A/B Testing Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">A/B Testing</h5>
                    <span class="badge bg-info">Step 3</span>
                </div>
                <div class="card-body">
                    <p class="card-text">Compare performance of multiple models and strategies</p>
                    <form id="abTestForm">
                        <div class="mb-3">
                            <label class="form-label">Select Models to Compare</label>
                            <div id="modelCheckboxes" class="list-group">
                                <!-- Model checkboxes will be added here dynamically -->
                                <div class="list-group-item">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="model-example" disabled>
                                        <label class="form-check-label text-muted" for="model-example">
                                            No models available yet
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-info" disabled>
                                <i class="fas fa-flask me-2"></i>Run A/B Test
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Imported Backtest Data</h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshData">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="clearData">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="backtestDataContainer">
                        <div class="text-center py-5" id="noDataMessage">
                            <i class="fas fa-database fs-2 text-muted mb-3"></i>
                            <p class="lead text-muted">No backtest data imported</p>
                            <p class="text-muted">Import backtest results from Freqtrade to start training AI models</p>
                        </div>
                        
                        <div id="backtestDataContent" style="display: none;">
                            <ul class="nav nav-tabs" id="dataTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary-tab-pane" type="button" role="tab">Summary</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="trades-tab" data-bs-toggle="tab" data-bs-target="#trades-tab-pane" type="button" role="tab">Trades</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="pairs-tab" data-bs-toggle="tab" data-bs-target="#pairs-tab-pane" type="button" role="tab">Pairs</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="monte-carlo-tab" data-bs-toggle="tab" data-bs-target="#monte-carlo-tab-pane" type="button" role="tab">Monte Carlo</button>
                                </li>
                            </ul>
                            <div class="tab-content pt-3" id="dataTabsContent">
                                <div class="tab-pane fade show active" id="summary-tab-pane" role="tabpanel" tabindex="0">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <table class="table table-sm">
                                                <tbody>
                                                    <tr>
                                                        <th>Strategy:</th>
                                                        <td id="summaryStrategy">-</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Timeframe:</th>
                                                        <td id="summaryTimeframe">-</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Period:</th>
                                                        <td id="summaryPeriod">-</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Total Trades:</th>
                                                        <td id="summaryTotalTrades">-</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <table class="table table-sm">
                                                <tbody>
                                                    <tr>
                                                        <th>Win Rate:</th>
                                                        <td id="summaryWinRate">-</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Profit:</th>
                                                        <td id="summaryProfit">-</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Max Drawdown:</th>
                                                        <td id="summaryDrawdown">-</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Sharpe Ratio:</th>
                                                        <td id="summarySharpe">-</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="trades-tab-pane" role="tabpanel" tabindex="0">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover" id="tradesTable">
                                            <thead>
                                                <tr>
                                                    <th>Pair</th>
                                                    <th>Open Time</th>
                                                    <th>Close Time</th>
                                                    <th>Open Price</th>
                                                    <th>Close Price</th>
                                                    <th>Profit %</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Trades will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="pairs-tab-pane" role="tabpanel" tabindex="0">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover" id="pairsTable">
                                            <thead>
                                                <tr>
                                                    <th>Pair</th>
                                                    <th>Trades</th>
                                                    <th>Win Rate</th>
                                                    <th>Profit %</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Pairs will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="monte-carlo-tab-pane" role="tabpanel" tabindex="0">
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h6 class="card-title mb-0">Monte Carlo Simulation</h6>
                                                </div>
                                                <div class="card-body">
                                                    <form id="monteCarloForm">
                                                        <div class="mb-3">
                                                            <label for="modelSelect" class="form-label">AI Model</label>
                                                            <select class="form-select" id="modelSelect">
                                                                <option value="" selected disabled>Select a model</option>
                                                            </select>
                                                            <div class="form-text">Select a trained AI model</div>
                                                        </div>
                                                        <div class="mb-2">
                                                            <label for="initialCapital" class="form-label">Initial Capital</label>
                                                            <div class="input-group">
                                                                <span class="input-group-text">$</span>
                                                                <input type="number" class="form-control" id="initialCapital" value="10000">
                                                            </div>
                                                        </div>
                                                        <div class="mb-2">
                                                            <label for="riskPerTrade" class="form-label">Risk Per Trade</label>
                                                            <div class="input-group">
                                                                <input type="number" class="form-control" id="riskPerTrade" value="1.0" step="0.1">
                                                                <span class="input-group-text">%</span>
                                                            </div>
                                                        </div>
                                                        <div class="mb-2">
                                                            <label for="tradingDays" class="form-label">Trading Days</label>
                                                            <input type="number" class="form-control" id="tradingDays" value="30">
                                                        </div>
                                                        <div class="mb-2">
                                                            <label for="tradesPerDay" class="form-label">Trades Per Day</label>
                                                            <input type="number" class="form-control" id="tradesPerDay" value="3.0" step="0.1">
                                                        </div>
                                                        <div class="mb-2">
                                                            <label for="winRateVariance" class="form-label">Win Rate Variance</label>
                                                            <div class="input-group">
                                                                <input type="number" class="form-control" id="winRateVariance" value="5.0" step="0.1">
                                                                <span class="input-group-text">%</span>
                                                            </div>
                                                        </div>
                                                        <div class="mb-2">
                                                            <label for="simulations" class="form-label">Simulations</label>
                                                            <input type="number" class="form-control" id="simulations" value="1000">
                                                        </div>
                                                        <div class="form-check mb-3">
                                                            <input class="form-check-input" type="checkbox" id="considerFees" checked>
                                                            <label class="form-check-label" for="considerFees">
                                                                Consider Trading Fees
                                                            </label>
                                                        </div>
                                                        <div class="d-grid">
                                                            <button type="submit" class="btn btn-primary">Run Simulation</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h6 class="card-title mb-0">Simulation Results</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div id="simulationInProgress" class="d-none">
                                                        <div class="text-center py-5">
                                                            <div class="spinner-border text-primary mb-3" role="status">
                                                                <span class="visually-hidden">Loading...</span>
                                                            </div>
                                                            <p>Running Monte Carlo simulation...</p>
                                                        </div>
                                                    </div>
                                                    
                                                    <div id="noSimulationResults" class="text-center py-5">
                                                        <i class="fas fa-chart-line fs-2 text-muted mb-3"></i>
                                                        <p class="lead text-muted">No simulation results</p>
                                                        <p class="text-muted">Run a simulation to see results</p>
                                                    </div>
                                                    
                                                    <div id="simulationResults" class="d-none">
                                                        <div class="row mb-4">
                                                            <div class="col-md-4">
                                                                <div class="border rounded p-3 text-center">
                                                                    <h6 class="text-muted">Mean Profit</h6>
                                                                    <h4 id="resultMeanProfit">-</h4>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <div class="border rounded p-3 text-center">
                                                                    <h6 class="text-muted">Success Rate</h6>
                                                                    <h4 id="resultSuccessRate">-</h4>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <div class="border rounded p-3 text-center">
                                                                    <h6 class="text-muted">Profit Factor</h6>
                                                                    <h4 id="resultProfitFactor">-</h4>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="mb-4">
                                                            <h6>Equity Curves</h6>
                                                            <canvas id="equityCurvesChart" height="200"></canvas>
                                                        </div>
                                                        
                                                        <div class="mb-4">
                                                            <h6>Final Equity Distribution</h6>
                                                            <canvas id="finalEquityChart" height="200"></canvas>
                                                        </div>
                                                        
                                                        <div class="card border-0 bg-light">
                                                            <div class="card-body">
                                                                <h6>AI Analysis</h6>
                                                                <p id="riskAssessment" class="mb-3"></p>
                                                                
                                                                <h6>Optimization Suggestions</h6>
                                                                <div id="optimizationSuggestions">
                                                                    <div class="table-responsive">
                                                                        <table class="table table-sm">
                                                                            <thead>
                                                                                <tr>
                                                                                    <th>Parameter</th>
                                                                                    <th>Current</th>
                                                                                    <th>Suggested</th>
                                                                                    <th>Impact</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody id="optimizationTable">
                                                                                <!-- Optimization suggestions will be populated here -->
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                                
                                                                <p id="advancedSuggestion" class="mt-3 mb-0"></p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Training Progress</h5>
                </div>
                <div class="card-body">
                    <div id="trainingStatus" class="d-none">
                        <div class="progress mb-3">
                            <div id="trainingProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span id="trainingStatusText">Preparing data...</span>
                            <span id="trainingTimeLeft">--:--</span>
                        </div>
                    </div>
                    
                    <div id="noTrainingStatus" class="text-center py-4">
                        <i class="fas fa-robot fs-2 text-muted mb-3"></i>
                        <p class="text-muted">No active training</p>
                    </div>
                    
                    <div id="trainingResults" class="d-none mt-3">
                        <h6>Training Results</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <canvas id="trainingLossChart" height="200"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <canvas id="featureImportanceChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-success">
                                    <strong>Success!</strong> Model trained and saved. <a href="#" id="viewModelDetails">View model details</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load strategies
    loadStrategies();
    
    // Load available pairs
    loadPairs();
    
    // Handle import form submission
    document.getElementById('importForm').addEventListener('submit', function(e) {
        e.preventDefault();
        importBacktestData();
    });
    
    // Handle train form submission
    document.getElementById('trainForm').addEventListener('submit', function(e) {
        e.preventDefault();
        trainModel();
    });
    
    // Handle refresh data button
    document.getElementById('refreshData').addEventListener('click', function() {
        loadImportedData();
    });
    
    // Handle clear data button
    document.getElementById('clearData').addEventListener('click', function() {
        if (confirm('Are you sure you want to clear all imported backtest data?')) {
            clearBacktestData();
        }
    });
    
    // Check for existing backtest data
    loadImportedData();
    
    // Load models for Monte Carlo tab
    loadModels();
    
    // Handle Monte Carlo form submission
    document.getElementById('monteCarloForm').addEventListener('submit', function(e) {
        e.preventDefault();
        runMonteCarloSimulation();
    });
    
    function loadStrategies() {
        fetch('/backtest_ai/api/get_strategies')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('strategySelect');
                select.innerHTML = '<option value="" selected disabled>Select a strategy</option>';
                
                if (data.success && data.strategies) {
                    data.strategies.forEach(strategy => {
                        const option = document.createElement('option');
                        option.value = strategy;
                        option.textContent = strategy;
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading strategies:', error);
                showAlert('danger', 'Could not load strategies. Check the console for details.');
            });
    }
    
    function loadPairs() {
        fetch('/backtest_ai/api/get_pairs')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('pairSelect');
                select.innerHTML = '<option value="" selected disabled>Select a pair</option>';
                
                if (data.success && data.pairs) {
                    data.pairs.forEach(pair => {
                        const option = document.createElement('option');
                        option.value = pair;
                        option.textContent = pair;
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading pairs:', error);
                showAlert('danger', 'Could not load pairs. Check the console for details.');
            });
    }
    
    function importBacktestData() {
        const fileInput = document.getElementById('backtestFile');
        const strategySelect = document.getElementById('strategySelect');
        
        if (!fileInput.files || fileInput.files.length === 0) {
            showAlert('warning', 'Please select a backtest file to import.');
            return;
        }
        
        if (!strategySelect.value) {
            showAlert('warning', 'Please select a strategy.');
            return;
        }
        
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('backtest_file', file);
        formData.append('strategy', strategySelect.value);
        
        // Show loading UI
        document.getElementById('importForm').classList.add('was-validated');
        const submitBtn = document.querySelector('#importForm button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Importing...';
        submitBtn.disabled = true;
        
        fetch('/backtest_ai/api/import_backtest', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Backtest data imported successfully!');
                loadImportedData();
                loadPairs(); // Refresh pairs list
            } else {
                showAlert('danger', `Import failed: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Error importing backtest data:', error);
            showAlert('danger', 'Failed to import backtest data. Check the console for details.');
        })
        .finally(() => {
            // Reset UI
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;
            document.getElementById('importForm').classList.remove('was-validated');
        });
    }
    
    function loadImportedData() {
        fetch('/backtest_ai/api/get_imported_data')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data && Object.keys(data.data).length > 0) {
                    // We have data, show it
                    document.getElementById('noDataMessage').style.display = 'none';
                    document.getElementById('backtestDataContent').style.display = 'block';
                    
                    // Update summary
                    document.getElementById('summaryStrategy').textContent = data.data.strategy;
                    document.getElementById('summaryTimeframe').textContent = data.data.timeframe;
                    document.getElementById('summaryPeriod').textContent = `${data.data.start_date} to ${data.data.end_date}`;
                    document.getElementById('summaryTotalTrades').textContent = data.data.total_trades;
                    document.getElementById('summaryWinRate').textContent = `${data.data.win_rate.toFixed(2)}%`;
                    document.getElementById('summaryProfit').textContent = `${data.data.profit.toFixed(2)}%`;
                    document.getElementById('summaryDrawdown').textContent = `${data.data.max_drawdown.toFixed(2)}%`;
                    document.getElementById('summarySharpe').textContent = data.data.sharpe_ratio.toFixed(2);
                    
                    // Update trades table
                    const tradesTable = document.getElementById('tradesTable').getElementsByTagName('tbody')[0];
                    tradesTable.innerHTML = '';
                    
                    data.data.trades.slice(0, 100).forEach(trade => {
                        const row = tradesTable.insertRow();
                        row.insertCell(0).textContent = trade.pair;
                        row.insertCell(1).textContent = trade.open_date;
                        row.insertCell(2).textContent = trade.close_date;
                        row.insertCell(3).textContent = trade.open_rate.toFixed(8);
                        row.insertCell(4).textContent = trade.close_rate.toFixed(8);
                        
                        const profitCell = row.insertCell(5);
                        profitCell.textContent = `${trade.profit_percent.toFixed(2)}%`;
                        profitCell.classList.add(trade.profit_percent >= 0 ? 'text-success' : 'text-danger');
                    });
                    
                    // Update pairs table
                    const pairsTable = document.getElementById('pairsTable').getElementsByTagName('tbody')[0];
                    pairsTable.innerHTML = '';
                    
                    data.data.pair_metrics.forEach(pair => {
                        const row = pairsTable.insertRow();
                        row.insertCell(0).textContent = pair.pair;
                        row.insertCell(1).textContent = pair.trades;
                        row.insertCell(2).textContent = `${pair.win_rate.toFixed(2)}%`;
                        
                        const profitCell = row.insertCell(3);
                        profitCell.textContent = `${pair.profit.toFixed(2)}%`;
                        profitCell.classList.add(pair.profit >= 0 ? 'text-success' : 'text-danger');
                    });
                } else {
                    // No data available
                    document.getElementById('noDataMessage').style.display = 'block';
                    document.getElementById('backtestDataContent').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error loading imported data:', error);
                showAlert('danger', 'Failed to load imported data. Check the console for details.');
            });
    }
    
    function clearBacktestData() {
        fetch('/backtest_ai/api/clear_imported_data', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Backtest data cleared successfully!');
                loadImportedData();
            } else {
                showAlert('danger', `Failed to clear data: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Error clearing backtest data:', error);
            showAlert('danger', 'Failed to clear backtest data. Check the console for details.');
        });
    }
    
    function trainModel() {
        const pairSelect = document.getElementById('pairSelect');
        const timeframeSelect = document.getElementById('timeframeSelect');
        const modelName = document.getElementById('modelName');
        
        if (!pairSelect.value) {
            showAlert('warning', 'Please select a trading pair.');
            return;
        }
        
        if (!timeframeSelect.value) {
            showAlert('warning', 'Please select a timeframe.');
            return;
        }
        
        if (!modelName.value.trim()) {
            showAlert('warning', 'Please enter a model name.');
            return;
        }
        
        // Get advanced parameters
        const params = {
            num_leaves: parseInt(document.getElementById('numLeaves').value),
            max_depth: parseInt(document.getElementById('maxDepth').value),
            learning_rate: parseFloat(document.getElementById('learningRate').value),
            n_estimators: parseInt(document.getElementById('nEstimators').value),
            use_gpu: document.getElementById('enableDML').checked
        };
        
        const requestData = {
            pair: pairSelect.value,
            timeframe: timeframeSelect.value,
            model_name: modelName.value,
            params: params
        };
        
        // Show loading UI
        document.getElementById('trainForm').classList.add('was-validated');
        const submitBtn = document.querySelector('#trainForm button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Starting...';
        submitBtn.disabled = true;
        
        // Show training status UI
        document.getElementById('noTrainingStatus').classList.add('d-none');
        document.getElementById('trainingStatus').classList.remove('d-none');
        document.getElementById('trainingResults').classList.add('d-none');
        
        fetch('/backtest_ai/api/train_model', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Start polling for training progress
                const trainId = data.train_id;
                pollTrainingProgress(trainId);
            } else {
                showAlert('danger', `Training failed: ${data.message}`);
                resetTrainingUI();
            }
        })
        .catch(error => {
            console.error('Error training model:', error);
            showAlert('danger', 'Failed to train model. Check the console for details.');
            resetTrainingUI();
        });
        
        function resetTrainingUI() {
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;
            document.getElementById('trainForm').classList.remove('was-validated');
            document.getElementById('noTrainingStatus').classList.remove('d-none');
            document.getElementById('trainingStatus').classList.add('d-none');
        }
    }
    
    function pollTrainingProgress(trainId) {
        const progressBar = document.getElementById('trainingProgress');
        const statusText = document.getElementById('trainingStatusText');
        const timeLeft = document.getElementById('trainingTimeLeft');
        
        const pollInterval = setInterval(() => {
            fetch(`/backtest_ai/api/training_status?train_id=${trainId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update progress
                        progressBar.style.width = `${data.progress}%`;
                        statusText.textContent = data.status;
                        timeLeft.textContent = data.time_left || '--:--';
                        
                        if (data.completed) {
                            clearInterval(pollInterval);
                            
                            // Show results
                            if (data.success && !data.error) {
                                showTrainingResults(data.model_id);
                            } else {
                                showAlert('danger', `Training failed: ${data.error || 'Unknown error'}`);
                                document.getElementById('noTrainingStatus').classList.remove('d-none');
                                document.getElementById('trainingStatus').classList.add('d-none');
                            }
                            
                            // Reset form
                            const submitBtn = document.querySelector('#trainForm button[type="submit"]');
                            submitBtn.innerHTML = 'Train AI Model';
                            submitBtn.disabled = false;
                            document.getElementById('trainForm').classList.remove('was-validated');
                        }
                    } else {
                        showAlert('warning', `Could not get training status: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error checking training status:', error);
                });
        }, 2000);
    }
    
    function showAlert(type, message) {
        const alertsContainer = document.getElementById('alertsContainer');
        const alertId = 'alert-' + Date.now();
        
        const alertHtml = `
            <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        alertsContainer.insertAdjacentHTML('beforeend', alertHtml);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 5000);
    }
    
    function loadModels() {
        fetch('/monte_carlo/api/models')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('modelSelect');
                select.innerHTML = '<option value="" selected disabled>Select a model</option>';
                
                if (data.success && data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = `${model.name} (${model.pair}, ${model.timeframe})`;
                        select.appendChild(option);
                    });
                } else {
                    // No models available
                    const option = document.createElement('option');
                    option.disabled = true;
                    option.textContent = 'No trained models available';
                    select.appendChild(option);
                }
            })
            .catch(error => {
                console.error('Error fetching models:', error);
            });
    }
    
    function runMonteCarloSimulation() {
        const modelSelect = document.getElementById('modelSelect');
        
        if (!modelSelect.value) {
            showAlert('warning', 'Please select a model for simulation.');
            return;
        }
        
        // Get form values
        const requestData = {
            model_id: parseInt(modelSelect.value),
            initial_capital: parseFloat(document.getElementById('initialCapital').value),
            risk_per_trade: parseFloat(document.getElementById('riskPerTrade').value),
            trading_days: parseInt(document.getElementById('tradingDays').value),
            trades_per_day: parseFloat(document.getElementById('tradesPerDay').value),
            win_rate_variance: parseFloat(document.getElementById('winRateVariance').value),
            simulations: parseInt(document.getElementById('simulations').value),
            consider_fees: document.getElementById('considerFees').checked
        };
        
        // Show loading UI
        document.getElementById('noSimulationResults').classList.add('d-none');
        document.getElementById('simulationResults').classList.add('d-none');
        document.getElementById('simulationInProgress').classList.remove('d-none');
        
        // Disable form while simulation runs
        const submitBtn = document.querySelector('#monteCarloForm button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Running...';
        submitBtn.disabled = true;
        
        fetch('/monte_carlo/api/run_simulation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Process simulation results
                displaySimulationResults(data.results, data.ai_analysis);
            } else {
                showAlert('danger', `Simulation failed: ${data.message}`);
                document.getElementById('simulationInProgress').classList.add('d-none');
                document.getElementById('noSimulationResults').classList.remove('d-none');
            }
        })
        .catch(error => {
            console.error('Error running simulation:', error);
            showAlert('danger', 'Failed to run simulation. Check the console for details.');
            document.getElementById('simulationInProgress').classList.add('d-none');
            document.getElementById('noSimulationResults').classList.remove('d-none');
        })
        .finally(() => {
            // Reset form
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;
        });
    }
    
    function displaySimulationResults(results, analysis) {
        // Hide loading, show results
        document.getElementById('simulationInProgress').classList.add('d-none');
        document.getElementById('noSimulationResults').classList.add('d-none');
        document.getElementById('simulationResults').classList.remove('d-none');
        
        // Update metrics
        document.getElementById('resultMeanProfit').textContent = `${results.mean_profit_pct.toFixed(2)}%`;
        document.getElementById('resultSuccessRate').textContent = `${results.success_rate.toFixed(2)}%`;
        document.getElementById('resultProfitFactor').textContent = results.profit_factor.toFixed(2);
        
        // Create equity curves chart
        const equityCtx = document.getElementById('equityCurvesChart').getContext('2d');
        
        // Generate labels (days)
        const totalDataPoints = results.percentiles.p50.length;
        const labels = Array.from({length: totalDataPoints}, (_, i) => i);
        
        new Chart(equityCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '90th Percentile',
                        data: results.percentiles.p90,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 1,
                        fill: false
                    },
                    {
                        label: '75th Percentile',
                        data: results.percentiles.p75,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        borderWidth: 1,
                        fill: false
                    },
                    {
                        label: 'Median (50th)',
                        data: results.percentiles.p50,
                        borderColor: 'rgba(255, 159, 64, 1)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        borderWidth: 2,
                        fill: false
                    },
                    {
                        label: '25th Percentile',
                        data: results.percentiles.p25,
                        borderColor: 'rgba(255, 205, 86, 1)',
                        backgroundColor: 'rgba(255, 205, 86, 0.1)',
                        borderWidth: 1,
                        fill: false
                    },
                    {
                        label: '10th Percentile',
                        data: results.percentiles.p10,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 1,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Equity Curve Percentiles'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Days'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Capital ($)'
                        }
                    }
                }
            }
        });
        
        // Create final equity distribution chart
        const finalEquityCtx = document.getElementById('finalEquityChart').getContext('2d');
        
        // Prepare histogram data
        const finalEquities = results.final_distribution;
        const min = Math.min(...finalEquities);
        const max = Math.max(...finalEquities);
        const binCount = 20;
        const binWidth = (max - min) / binCount;
        
        // Create bins
        const bins = Array.from({length: binCount}, (_, i) => min + i * binWidth);
        const counts = Array(binCount).fill(0);
        
        // Fill bins with data
        finalEquities.forEach(equity => {
            const binIndex = Math.min(Math.floor((equity - min) / binWidth), binCount - 1);
            counts[binIndex]++;
        });
        
        // Normalize counts to percentages
        const percentages = counts.map(count => (count / finalEquities.length) * 100);
        
        new Chart(finalEquityCtx, {
            type: 'bar',
            data: {
                labels: bins.map(b => b.toFixed(0)),
                datasets: [{
                    label: 'Distribution (%)',
                    data: percentages,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Final Equity Distribution'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Final Capital ($)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Frequency (%)'
                        }
                    }
                }
            }
        });
        
        // Display AI analysis
        document.getElementById('riskAssessment').textContent = analysis.risk_assessment;
        
        // Display optimization suggestions
        const optimizationTable = document.getElementById('optimizationTable');
        optimizationTable.innerHTML = '';
        
        analysis.optimizations.forEach(opt => {
            const row = optimizationTable.insertRow();
            row.insertCell(0).textContent = opt.parameter;
            row.insertCell(1).textContent = opt.current;
            row.insertCell(2).textContent = opt.suggested;
            row.insertCell(3).textContent = opt.impact;
        });
        
        document.getElementById('advancedSuggestion').textContent = analysis.advanced_suggestion;
    }
    
    function showTrainingResults(modelId) {
        fetch(`/backtest_ai/api/model_details?model_id=${modelId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show results UI
                    document.getElementById('trainingStatus').classList.add('d-none');
                    document.getElementById('trainingResults').classList.remove('d-none');
                    
                    // Create loss chart
                    const lossCtx = document.getElementById('trainingLossChart').getContext('2d');
                    new Chart(lossCtx, {
                        type: 'line',
                        data: {
                            labels: Array.from({length: data.training_history.length}, (_, i) => i + 1),
                            datasets: [{
                                label: 'Training Loss',
                                data: data.training_history.map(h => h.train_loss),
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1
                            }, {
                                label: 'Validation Loss',
                                data: data.training_history.map(h => h.val_loss),
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Training Loss'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    });
                    
                    // Create feature importance chart
                    const featureImportanceCtx = document.getElementById('featureImportanceChart').getContext('2d');
                    const features = Object.keys(data.feature_importance);
                    const importance = Object.values(data.feature_importance);
                    
                    // Sort by importance
                    const featureData = features.map((f, i) => ({
                        feature: f,
                        importance: importance[i]
                    })).sort((a, b) => b.importance - a.importance).slice(0, 10);
                    
                    new Chart(featureImportanceCtx, {
                        type: 'bar',
                        data: {
                            labels: featureData.map(d => d.feature),
                            datasets: [{
                                label: 'Feature Importance',
                                data: featureData.map(d => d.importance),
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Top 10 Feature Importance'
                                }
                            }
                        }
                    });
                    
                    // Set up link to model details
                    document.getElementById('viewModelDetails').href = `/models?id=${modelId}`;
                } else {
                    showAlert('danger', `Could not load model details: ${data.message}`);
                    document.getElementById('noTrainingStatus').classList.remove('d-none');
                    document.getElementById('trainingResults').classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Error loading model details:', error);
                showAlert('danger', 'Failed to load model details. Check the console for details.');
                document.getElementById('noTrainingStatus').classList.remove('d-none');
                document.getElementById('trainingResults').classList.add('d-none');
            });
    }
});
</script>
{% endblock %}